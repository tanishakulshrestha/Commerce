{% extends "auctions/layout.html" %}

{% block body %}
<h2>Listing: {{ listing.title }}</h2>

{% if listing.image_url %}
    <img src="{{ listing.image_url }}" width="400">
{% endif %}

<p>{{ listing.description }}</p>

<h4>
    {% if highest_bid %}
        ${{ current_price }}
    {% else %}
        ${{ listing.starting_bid }}
    {% endif %}
</h4>

<p>
    {% if bids_count > 0 %}
        {{ bids_count }} bid(s) so far.
    {% else %}
        No bids yet.
    {% endif %}
</p>

{% if user.is_authenticated %}
    <form action="{% url 'place_bid' listing.id %}" method="post">
    {% csrf_token %}

{% if user.is_authenticated and user == listing.owner and listing.active %}
    <form action="{% url 'close_auction' listing.id %}" method="post">
        {% csrf_token %}
        <button class="button danger">Close Auction</button>
    </form>
{% endif %}
{% if listing.active %}
    {% if user.is_authenticated %}
        <form action="{% url 'place_bid' listing.id %}" method="post">
            {% csrf_token %}
            <input type="number" step="0.01" name="bid" required>
            <button type="submit">Place Bid</button>
        </form>
    {% else %}
        <p><a href="{% url 'login' %}">Login</a> to bid.</p>
    {% endif %}
{% else %}
    <p><strong>Auction Closed</strong></p>
{% endif %}
{% if not listing.active %}
    {% if listing.winner %}
        {% if user == listing.winner %}
            <p style="color:green;"><strong>üéâ You won this auction!</strong></p>
        {% else %}
            <p><strong>Winner:</strong> {{ listing.winner.username }}</p>
        {% endif %}
    {% else %}
        <p>No bids were placed.</p>
    {% endif %}
{% endif %}
{% if user == listing.owner and listing.active %}
    <form action="{% url 'close_auction' listing.id %}" method="post">
        {% csrf_token %}
        <button type="submit" style="background:red;">Close Auction</button>
    </form>
{% endif %}

{% if not listing.active %}
    <hr>
    <h3>Auction Closed</h3>

    {% if highest_bid %}
        <p>
            üèÜ <strong>Winner:</strong> {{ highest_bid.bidder.username }} <br>
            üí∞ <strong>Winning Bid:</strong> ‚Çπ {{ highest_bid.amount }}
        </p>
    {% else %}
        <p>No bids were placed on this auction.</p>
    {% endif %}
{% endif %}
{% if listing.active %}
    <!-- bid form -->
{% else %}
    <p><strong>Bidding is closed.</strong></p>
{% endif %}

{% if user.is_authenticated %}
    <form action="{% url 'toggle_watchlist' listing.id %}" method="post">
        {% csrf_token %}
        {% if user in listing.watchlist.all %}
            <button class="button">Remove from Watchlist</button>
        {% else %}
            <button class="button">Add to Watchlist</button>
        {% endif %}
    </form>
{% endif %}

    <input
        type="number"
        name="bid"
        step="0.01"
        required
        placeholder="Enter your bid"
    >

    <button type="submit">Place Bid</button>
</form>

{% else %}
    <p>Login to place a bid.</p>
{% endif %}

<hr>
<h3>Comments</h3>

{% if user.is_authenticated %}
<form action="{% url 'add_comment' listing.id %}" method="post">
    {% csrf_token %}
    <textarea name="comment" rows="3" required></textarea>
    <br>
    <button type="submit">Add Comment</button>
</form>
{% else %}
<p><a href="{% url 'login' %}">Login</a> to comment.</p>
{% endif %}
{% for comment in comments %}
    <div class="comment">
        <strong>{{ comment.user.username }}</strong>
        <small>{{ comment.created_at }}</small>
        <p>{{ comment.text }}</p>
    </div>
{% empty %}
    <p>No comments yet.</p>
{% endfor %}

<h4>Details</h4>
<ul>
    <li>Listed by: {{ listing.owner.username }}</li>
    <li>Category: {{ listing.category|default:"No Category Listed" }}</li>
</ul>

{% endblock %}
