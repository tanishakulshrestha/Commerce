{% extends "auctions/layout.html" %}

{% block body %}
<h2>Listing: {{ listing.title }}</h2>

{% if listing.image_url %}
    <img src="{{ listing.image_url }}" width="400">
{% endif %}

<p>{{ listing.description }}</p>

<h4>
    <strong>Current Price:</strong>
    ‚Çπ {% if highest_bid %}{{ current_price }}{% else %}{{ listing.starting_bid }}{% endif %}
</h4>

<p>
    {% if bids_count > 0 %}
        {{ bids_count }} bid(s) so far.
    {% else %}
        No bids yet.
    {% endif %}
</p>

{% if predicted_price %}
<p style="color: green; font-weight: bold;">
    Predicted Winning Price: ‚Çπ {{ predicted_price }}
</p>
{% endif %}

{% if listing.active %}
    {% if user.is_authenticated %}
        <form action="{% url 'place_bid' listing.id %}" method="post">
            {% csrf_token %}
            <input type="number" step="0.01" name="bid" required placeholder="Enter your bid">
            <button type="submit">Place Bid</button>
        </form>
    {% else %}
        <p><a href="{% url 'login' %}">Login</a> to place a bid.</p>
    {% endif %}

    {% if user == listing.owner %}
        <form action="{% url 'close_auction' listing.id %}" method="post">
            {% csrf_token %}
            <button type="submit" style="background:red;">Close Auction</button>
        </form>
    {% endif %}
{% else %}
    <p><strong>Auction Closed</strong></p>

    {% if highest_bid %}
        <p style="color:blue; font-weight:bold;">
            üèÜ Winner: {{ highest_bid.bidder.username }} <br>
            üí∞ Winning Bid: ‚Çπ {{ highest_bid.amount }}
        </p>
        {% if user == highest_bid.bidder %}
            <p style="color:green;"><strong>üéâ You won this auction!</strong></p>
        {% endif %}
    {% else %}
        <p>No bids were placed on this auction.</p>
    {% endif %}
{% endif %}

<hr>
<h3>Comments</h3>
{% if user.is_authenticated %}
<form action="{% url 'add_comment' listing.id %}" method="post">
    {% csrf_token %}
    <textarea name="comment" rows="3" required></textarea>
    <br>
    <button type="submit">Add Comment</button>
</form>
{% else %}
<p><a href="{% url 'login' %}">Login</a> to comment.</p>
{% endif %}

{% for comment in comments %}
    <div class="comment">
        <strong>{{ comment.user.username }}</strong>
        <small>{{ comment.created_at }}</small>
        <p>{{ comment.text }}</p>
    </div>
{% empty %}
    <p>No comments yet.</p>
{% endfor %}

<h4>Details</h4>
<ul>
    <li>Listed by: {{ listing.owner.username }}</li>
    <li>Category: {{ listing.category|default:"No Category Listed" }}</li>
</ul>

{% if user.is_authenticated %}
<form action="{% url 'toggle_watchlist' listing.id %}" method="post">
    {% csrf_token %}
    {% if user in listing.watchlist.all %}
        <button class="button">Remove from Watchlist</button>
    {% else %}
        <button class="button">Add to Watchlist</button>
    {% endif %}
</form>
{% endif %}

{% endblock %}
